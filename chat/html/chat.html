<!DOCTYPE html>
<html lang="en-US">

<head>
    <link rel="icon" href="https://www.moosen.im/images/favicon.png">
    <meta charset="utf-8">
    <title>Moosen Chat</title>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-112336897-1"></script>
    <script>
        window.dataLayer = window.dataLayer || []

        function gtag() {
            dataLayer.push(arguments)
        }
        gtag('js', new Date())
        gtag('config', 'UA-112336897-1')
    </script>

    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <!-- JQuery loaded first -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js"></script>
    <script src="../siofu/client.js"></script>
    <!-- Popper.js, then Bootstrap JS -->
    <script src="https://unpkg.com/popper.js@1.12.6/dist/umd/popper.js" integrity="sha384-fA23ZRQ3G/J53mElWqVJEGJzU0sTs+SvzG8fXVWP+kJQ1lwFAOkcUOysnlKJC33U"
        crossorigin="anonymous"></script>
    <script src="https://unpkg.com/bootstrap-material-design@4.0.0-beta.4/dist/js/bootstrap-material-design.js" integrity="sha384-3xciOSDAlaXneEmyOo0ME/2grfpqzhhTcM4cE32Ce9+8DW/04AGoTACzQpphYGYe"
        crossorigin="anonymous"></script>
    <script src="../js/autosize.js"></script>
    <script>
        $(document).ready(function () {
            $('body').bootstrapMaterialDesign()
        })
    </script>

    <!-- MATERIALIZE CSS AND JS FOR RESPONSIVE IMAGES -->
    <link rel="stylesheet" type="text/css" href="../css/materialbox.css">
    <script src="../js/materialbox.js"></script>
    <script src="../js/velocity.min.js"></script>

    <source id="ogg_src" src="../sounds/notification.mp3" type="video/ogg">

    <!-- Material Design for Bootstrap fonts and icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Material+Icons">
    <!-- Material Design for Bootstrap CSS -->
    <link rel="stylesheet" href="https://unpkg.com/bootstrap-material-design@4.0.0-beta.4/dist/css/bootstrap-material-design.min.css"
        integrity="sha384-R80DC0KVBO4GSTw+wZ5x2zn2pu4POSErBkf8/fSFhPXHxvHJydT0CSgAP2Yo2r4I" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="../css/chat.css">

    <!--Import Google Font-->
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans" rel="stylesheet">
    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <style>
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg">
        <a class="btn mm-navbtn" data-toggle="drawer" data-target="#dw-s1">
            <i class="material-icons">menu</i>
        </a>
        <a class="navbar-brand" id="title" href="#">m.im</a>


        <div class="dropdown mm-navdd">
            <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                <i class="material-icons">settings</i>
            </button>
            <div class="dropdown-menu mm-navdd-items" aria-labelledby="dropdownMenuButton">
                <div class="nav-item">
                    <a class="nav-link" data-toggle="modal" data-target="#add-modal">Add To Current Room</a>
                </div>
                <div class="nav-item">
                    <a class="nav-link" data-toggle="modal" data-target="#modal2">Create New Room</a>
                </div>
                <div class="nav-item">
                    <a class="nav-link" data-toggle="modal" data-target="#joincode-modal">Enter a Join Code</a>
                </div>
                <div class="nav-item">
                    <a class="nav-link" data-toggle="modal" data-target="#welcome-modal">Help</a>
                </div>
                <div class="nav-item">
                    <a class="nav-link" data-toggle="modal" data-target="#regex-modal" id="room-commands">Room Commands</a>
                </div>
                <div class="nav-item">
                    <a class="nav-link" data-toggle="modal" data-target="#color-modal" id="room-custom">Room Customization</a>
                </div>

            </div>
        </div>

        <div class="dropdown mm-navdd">
            <button class="btn btn-secondary dropdown-toggle" style="margin-left:0px" type="button" id="dropdownMenuButton" data-toggle="dropdown"
                aria-haspopup="true" aria-expanded="false">
                <i class="material-icons">account_circle</i>
            </button>
            <div class="dropdown-menu mm-navdd-items" aria-labelledby="dropdownMenuButton">
                <div class="nav-item">
                    <a class="nav-link">Profile (Currently unavailible)</a>
                </div>
            </div>
        </div>
        <a class="btn mm-navbtn" data-toggle="drawer" data-target="#dw-s2">
            <i class="material-icons">menu</i>
        </a>
    </nav>
    <div class="bmd-layout-container bmd-drawer-f-l bmd-drawer-overlay main">
        <div id="dw-s1" class="bmd-layout-drawer bg-faded mm-side">
            <ul class="nav flex-column" id="mm-side-list">
            </ul>
        </div>
        <main class="bmd-layout-content" id="maindiv">
            <div class="row">
                <div class="col">
                    <ul class="mm-collection" id="messages">
                    </ul>
                </div>
            </div>
            <div class="row">
                <form class="mm-form" autocomplete="off">
                    <div class="input-group">
                        <textarea type="text" id="send-message" class="form-control" placeholder="Message" name="message"></textarea>
                        <div class="input-group-btn">
                            <label name="files[]" id="add_pics" class="btn">
                                <i class="material-icons" style="margin-left:-0.7rem">add</i>
                                <input style="display: none" type="file" multiple>
                            </label>
                            <button type="submit" class="btn mm-submit">
                                <i class="material-icons">send</i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </main>
    </div>
    <div class="bmd-layout-container bmd-drawer-f-r bmd-drawer-overlay main">
        <div id="dw-s2" class="bmd-layout-drawer bg-faded mm-side">
            <ul class="nav flex-column" id="mm-side-list-2">
            </ul>
        </div>
    </div>
    <!-- Modal list -->
    <div class="modal fade" id="welcome-modal" tabindex="-1" role="dialog" aria-labelledby="welcome-modal-label" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="welcome-modal-label">Welcome to Moosen IM</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Moosen IM is a instant messaging application made by a couple of friends who want more out of their messaging
                        apps.
                        <br>
                        <br>To get started, click on 'Create Room' and give it a catchy name. Then, use 'Add to Room...' to invite
                        other users to your room. Alternatively, You can use the join code.
                        <br>
                        <br>For any feature requests, reporting a bug, or want to talk to the devs, please click on the "Report
                        bug/Request feature" room.
                        <br>
                        <br>DISCLAIMER: This is an MVP product, and is not finished, nor does it have all features we hope to
                        offer.
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="btn" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal add user -->
    <div class="modal fade" id="add-modal" tabindex="-1" role="dialog" aria-labelledby="add-modal-label" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="add-modal-label">Add to Room</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Enter the email of the person you wish to invite</p>
                    <form id="email" action="">
                        <input class="form-control" type="text" id="e" placeholder="email">
                        <button class="btn waves-effect waves-light modal-close light-blue white-text"> Add to Room </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal room color settings -->
    <div class="modal fade" id="color-modal" tabindex="-1" role="dialog" aria-labelledby="add-modal-label" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="add-modal-label">Room Customization</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Change room color settings</p>
                    <form id="room-color" action="">
                        Primary Background Color:
                        <input type="color" class="form-control color-form" id="back-color1"> Secondary Background Color:
                        <input type="color" class="form-control color-form" id="back-color2"> Text Color:
                        <input type="color" class="form-control color-form" id="text-color"> Transparent Message Background?:
                        <input type="checkbox" class="form-control" id="msg-trans"> Primary Message Background Color:
                        <input type="color" class="form-control color-form" id="msg-color1"> Secondary Message Background Color:
                        <input type="color" class="form-control color-form" id="msg-color2">
                        <br />
                        <button class="btn btn-primary waves-effect waves-light modal-close light-blue white-text"> Set Colors </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal use join code -->
    <div class="modal fade" id="joincode-modal" tabindex="-1" role="dialog" aria-labelledby="add-modal-label" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="add-modal-label">Enter Join Code</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Paste in a join code to join a friend's room</p>
                    This room's join code is:
                    <p id="jc-room">
                        join code
                    </p>
                    <form id="jc-form" action="">
                        <input class="form-control" type="text" id="jc" placeholder="Enter a join code">
                        <button class="btn waves-effect waves-light modal-close light-blue white-text"> Enter </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal create room -->
    <div class="modal fade" id="modal2" tabindex="-1" role="dialog" aria-labelledby="add-modal-label" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="add-modal-label">Create New Room</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Enter a Room Name</p>
                    <form id="roomname" action="">
                        <input class="form-control" type="text" id="rn" placeholder="room name">
                        <button class="btn waves-effect waves-light modal-close light-blue white-text"> Create Room </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal create room -->
    <div class="modal fade" id="regex-modal" tabindex="-1" role="dialog" aria-labelledby="add-modal-label" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="add-modal-label">Add new regex command</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Enter a new Command</p>
                    <form id="newcommand-form" action="">
                        <input class="form-control" type="text" id="nc-cmd" placeholder="if command is 'test', it can be called with'!test'">
                        <select class="form-control" name="nc-actn" id="nc-actn">
                            <option value="Replace">Replace</option>
                            <option value="ReplaceEmbed">ReplaceEmbed</option>
                            <option value="ReplaceWhole">ReplaceWhole</option>
                            <option value="Respond">Respond</option>
                        </select>
                        <input class="form-control" type="text" id="nc-msg" placeholder="message">
                        <input class="form-control" type="text" id="nc-username" placeholder="username">
                        <input class="form-control" type="text" id="nc-pic" placeholder="picture">
                        <button class="btn waves-effect waves-light modal-close light-blue white-text"> Add Rule </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div id="modal2" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="add-modal-label">
                    <h4>Create new Room</h4>
                    <div class="modal-body">

                    </div>
            </div>
        </div>
    </div>


    <!-- Socket.io -->
    <script>
        var event
        $(function () {
            var last_id
            var retrieving = false
            var first_id
            var saved_first = "messages"
            var retrievePrevious = false
            var URL_SERVER = 'https://moosen.im:443'
            var socket = io.connect(URL_SERVER)
            var doRegex = true
            var roomCommands = []
            var roomRegex = []
            var curroom
            var canAuto = false
            var canScroll = 10

            var css = {
                backImg: "",
                back1: "#23ffdd",
                back2: "#6eb7ff",
                text1: "#000000",
                text2: "#444444",
                mb1: "rgba(0, 0, 0, 0.25)",
                mb2: "rgba(255, 255, 255, 0.25)",
            }

            handleCSS()

            var siofu = new SocketIOFileUpload(socket)
            siofu.addEventListener("start", event => {
                event.file.meta.filetype = event.file.type
                event.file.meta.room = curroom
            })

            $.fn.textWidth = function () {
                var text = $(this).html()
                $(this).html('<span>' + text + '</span>')
                var width = $(this).find('span:first').width()
                $(this).html(text)
                return width
            }

            $(document).ready(function () {
                // run test on initial page load
                checkSize()
                // run test on resize of the window
                $(window).resize(checkSize)
            })
            //Function to the css rule
            function checkSize() {
                if ($(".mm-navdd").css("max-width") !== "none") {
                    $(".bmd-layout-container").addClass("bmd-drawer-overlay")
                } else {
                    $(".bmd-layout-container").removeClass("bmd-drawer-overlay")
                }
            }

            var login = new Audio('../sounds/notification.mp3')
            var audio = new Audio('../sounds/login3.mp3')
            // roomList holds an array of all chatrooms a user has access to.
            // var roomList


            $('#email').submit(function () {
                socket.emit('adduser', $('#e').val(), curroom, 0)
                console.log("form submitted " + $('#e').val())
                $('#add-modal').modal('hide')
                return false
            })
            $('#jc-form').submit(function () {
                console.log('In jc-form submit')
                socket.emit('joincode', $('#jc').val(), curroom, 0)
                console.log("jc-form submitted " + $('#e').val())
                $('#joincode-modal').modal('hide')
                return false
            })
            $('#room-color').submit(function () {
                socket.emit('updateroomtheme', [$('#back-color1').val(), $('#back-color2').val(), null,
                    $('#text-color').val(), $('#text-color').val(), $('#msg-color1').val(), $(
                        '#msg-color2').val(), $('#msg-trans')[0].checked
                ], null, 1, curroom)
                console.log('room-color submitted')
                $('#color-modal').modal('hide')
                return false
            })
            $('#newcommand-form').submit(function () {
                socket.emit('addcommand', curroom, $('#nc-cmd').val(), $('#nc-actn').val(), $('#nc-msg')
                    .val(), $('#nc-username').val(), $('#nc-pic').val())
                console.log("form submitted " + $('#nc-cmd').val())
                $('#regex-modal').modal('hide')
                return false
            })
            $('#roomname').submit(function () {
                socket.emit('addroom', $('#rn').val())
                console.log("add room form submitted " + $('#rn').val())
                $('#modal2').modal('hide')
                return false
            })

            $('.mm-form').submit(function (e) {
                e.preventDefault()
                var message = $('#send-message').val()
                if (message) {
                    try {
                        socket.emit('chat message', message, curroom)
                        //      console.log(`Emitting chat message ${message} for room ${curroom}`)
                    } catch (e) {
                        console.log(e)
                    }

                    checkScroll()
                }
                autosize(document.querySelectorAll('textarea'))
                $('#send-message').val('')
                return false
            })

            $('#send-message').on('input', function () {
                $(this).scrollTop($('.main')[0].scrollHeight)
            })

            $('#send-message').keypress(function (e) {
                if (e.which == 13 && !e.shiftKey) {
                    $(this).closest('form').submit()
                    e.preventDefault()
                }
            })

            $(document).ready(function () {
                $('.mm-side-item-text').each(function (index) {
                    $(this).css('font-size', '1em')
                    while ($(this).textWidth() > $('#dw-s1').width() * 0.65) {
                        $(this).css('font-size', (parseInt($(this).css('font-size')) - 1) +
                            "px")
                    }
                })
            })

            autosize(document.querySelectorAll('textarea'))

            var last_scroll_position = 0

            $('main').scroll(function () {
                if ($('main').scrollTop() + $('main').height() >= $('main').prop('scrollHeight') - 300) {
                    if (!canAuto) {
                        canAuto = true
                        // console.log('canAuto true')
                    }
                } else if (canAuto) {
                    canAuto = false
                    // console.log('canAuto false')
                }
                if ($('main').scrollTop() == 0 && $('main').scrollTop() - last_scroll_position < 0) {
                    $('main').scrollTop(1)
                    if (canScroll >= 10) {
                        canScroll = 0
                        socket.emit('retPre', first_id, curroom)
                    } else {
                        console.log('Couldn\'t scroll: ' + canScroll)
                    }
                }
                last_scroll_position = $('main').scrollTop()
            })

            $(window).resize(function () { //checking for window resize event
                if ($("#send-message").is(":focus")) {
                    $('main').scrollTop($('main').prop("scrollHeight"))
                }
            })

            // socket.on('motd update', (msg, room) => {
            //     console.log('Received MOTD: ' + msg)
            //     roomnames.forEach(e => {
            //         if (e.id == curroom) $('#roomtitle').html('<h3>' + e.name + '</h3>')
            //     })
            //     $('#motd').html("<div>" + msg + "</div>")
            //     $(function () {
            //         $('#motd div').css('font-size', '3.3em')

            //         while ($('#motd div').height() > $('#motd').height()) {
            //             $('#motd div').css('font-size', (parseInt($('#motd div').css('font-size')) - 1) + "px")
            //         }
            //     })
            // })

            socket.on('get commands', commandsArr => {
                roomCommands = []
                roomRegex = []
                commandsArr.forEach(element => {
                    if (element.cmd.substr(0, 1) == "!") {
                        // console.log(element)
                        roomCommands.push(element)
                    } else {
                        roomRegex.push(element)
                    }
                })
            })

            socket.on('chat message', (user, msg, time, id, pic, room, badge) => {
                if (!curroom || curroom == room) {
                    if (!curroom) {
                        curroom = room
                    }

                    checkRegex(checkTags)

                    function checkRegex(cb) {
                        var sendmsg = msg
                        var regexes = [{
                                'x': 'https?:\\/\\/(?!.*(gfycat\\.|youtu\\.|youtube\\.|cdn\\.discordapp\\.com\\/emojis))\\S*\\.(jpg|gif|png|svg)\\S*',
                                'r': "<img class='materialboxed responsive-img mm-embed' src='$&' alt='$&'>"
                            },
                            {
                                'x': '\\S+gfycat\\.com\\/(gifs\\/detail\\/)?(\\S+)',
                                'r': '$& <br><div class="embed-responsive embed-responsive-16by9"><iframe class="embed-responsive-item" src="https://gfycat.com/ifr/$2" allowfullscreen></iframe></div>'
                            },
                            {
                                'x': 'https\\S*youtube\\.com\\/watch\\?v=(\\S*)',
                                'r': '$& <br><div class="embed-responsive embed-responsive-16by9"><iframe class="embed-responsive-item" src="https://www.youtube.com/embed/$1?rel=0" allowfullscreen></iframe></div>'
                            },
                            {
                                'x': 'https\\S*youtu\\.be\\/(\\S{11})',
                                'r': '$& <br><div class="embed-responsive embed-responsive-16by9"><iframe class="embed-responsive-item" src="https://www.youtube.com/embed/$1?rel=0" allowfullscreen></iframe></div>'
                            },
                            {
                                'x': '([^\'"]|^)(http\\S+\\.\\S+)(\\s|$)',
                                'r': "$1<a href='$2' target='_blank'>$2</a>$3"
                            },
                        ]
                        regexes.forEach(e => {
                            const promise = new Promise((resolve, reject) => {
                                var reg = new RegExp(e.x, 'ig')
                                sendmsg = sendmsg.replace(reg, e.r)
                                resolve()
                            })
                        })

                        if (doRegex) {
                            if (sendmsg.substr(0, 1) == "!") {
                                var command = /\S+/i.exec(sendmsg)
                                roomCommands.forEach(element => {
                                    if (command[0] == element.cmd) {
                                        switch (element.actn) {
                                            case "Replace":
                                                sendmsg = element.msg
                                                break
                                            case "ReplaceWhole":
                                                sendmsg = element.msg
                                                break
                                            case "ReplaceEmbed":
                                                sendmsg = element.msg
                                                break
                                            case "Respond":
                                                sendResponse(element, id + 0.5)
                                                break
                                            default:
                                                break
                                        }
                                    }
                                })
                            } else {
                                roomRegex.forEach(element => {
                                    var re = new RegExp('(^|\\s)(' + element.cmd + ')($|\\s)',
                                        'ig')
                                    var testedPositive = re.test(sendmsg)
                                    if (testedPositive) {
                                        switch (element.actn) {
                                            case "Replace":
                                                sendmsg = sendmsg.replace(re,
                                                    `$1${element.msg}$3`)
                                                break
                                            case "ReplaceWhole":
                                                sendmsg = element.msg
                                                break
                                            case "ReplaceEmbed":
                                                sendmsg = sendmsg.replace(re,
                                                    `$1${element.msg}$3`)
                                                break
                                            case "Respond":
                                                sendResponse(element, id + 0.5)
                                                break
                                            default:
                                                break
                                        }
                                    }
                                })
                            }
                        }
                        cb(sendmsg, doRest)
                    }

                    function checkTags(newMsg, cb) {
                        cb(newMsg)
                    }

                    async function sendResponse(e, thisId) {
                        await sleep(750)
                        insertMessage('<li id="' + thisId +
                            '" class="mm-collection-item avatar"><img src="' + e.pic +
                            '" alt="" class="circle"><span class="title" id="msgtitle">' +
                            e.username +
                            ' <span class="badge badge-dark">Bot</span></span><p class="message">' +
                            e.msg + '</p><span class="secondary-content">' +
                            time + '</a></li>', thisId, e.username, e.msg)
                    }

                    function doRest(newMsg) {
                        if (!newMsg) {
                            newMsg = "Server down for testing"
                        }
                        if (!retrieving) {
                            retrieving = true
                            if ($('#messages').children().first().attr('id')) {
                                saved_first = $('#messages').children().first().attr('id')
                            }
                            pageJump()
                        }
                        if (document.hidden) {
                            notifyMe(newMsg, pic)
                            login.play()
                        }
                        const badgeCheck = new Promise((resolve) => {
                                if (badge) {
                                    // console.log('HAS BADGE: ' + badge)
                                    resolve(user + ' <span class="badge badge-dark">' + badge +
                                        '</span>')
                                } else {
                                    // console.log('HAS NO BADGE: ' + badge)
                                    resolve(user)
                                }
                            })
                            .then((userStr) => {
                                if (!first_id) {
                                    first_id = id
                                    $('#messages').append('<li id="' + id +
                                        '" class="mm-collection-item avatar"><img src="' + pic +
                                        '" alt="" class="circle"><span class="title" id="msgtitle">' +
                                        userStr + '</span><p class="message">' +
                                        newMsg + '</p><span class="secondary-content">' +
                                        time + '</a></li>')
                                    document.title = user.replace(/ .*/, '') + ': ' + newMsg
                                    handleMessageCSS()
                                } else {
                                    insertMessage('<li id="' + id +
                                        '" class="mm-collection-item avatar"><img src="' + pic +
                                        '" alt="" class="circle"><span class="title" id="msgtitle">' +
                                        userStr + '</span><p class="message">' +
                                        newMsg + '</p><span class="secondary-content">' +
                                        time + '</a></li>', id, user, newMsg)
                                    if (first_id > id) {
                                        first_id = id
                                    }
                                }
                            })

                        $('.materialboxed').materialbox()
                    }
                } else {
                    // console.log($("a[room='" + room + "']").children())
                    // if ($("a[room='" + room + "']").children().hasClass('none')) {
                    //     console.log('has class none')
                    //     $("a[room='" + room + "']").children().removeClass('none')
                    //     $("a[room='" + room + "']").children().addClass('new badge deep-orange accent-3')
                    //     $("a[room='" + room + "']").children().text('1')
                    // } else {
                    //     var curtext = parseInt($("a[room='" + room + "']").first().children().text())
                    //     console.log('curtext: ' + curtext)
                    //     curtext = curtext + 1
                    //     curtext = curtext.toString()
                    //     console.log('curtext: ' + curtext)
                    //     $("a[room='" + room + "']").children().text(curtext)
                    // }

                    console.log($("a[room='" + room + "']").parent())
                    if ($("a[room='" + room + "']").parent().has('.notify-msg').length >= 1) {
                        console.log("This has a notification already")
                    } else {
                        $("a[room='" + room + "']").parent().append(
                            '<div class="notify notify-msg"></div>')
                    }
                }
            })

            socket.on('login', (displayName, email, photoURL, userId, room) => {
                console.log("Logging in " + displayName + ", email: " + email + " " + userId)
                if (room == curroom) {
                    $('#mm-side-list-2').append(
                        `<li class="nav-item mm-side-image"><img src="${photoURL}" alt="" class="circle img-fluid"><a class="nav-link mm-side-item-text" data-toggle="drawer" data-target="#dw-s2" user="${userId}">${displayName}</a></li>`
                    )
                    checkScroll()
                    if (document.hidden) {
                        login.play()
                    }
                }
            })

            socket.on('test', name => {
                console.log(name + "asdasd")
            })

            socket.on('disconnect', name => {
                location.reload()
            })

            socket.on('roomlist', list => {

                $('#mm-side-list').empty()
                try {
                    list.forEach(element => {
                        var roomlist = {
                            name: element.name,
                            id: element.serialid,
                            isAdmin: element.is_admin
                        }

                        // console.log('color:' + element.back1)

                        if (element.serialid == curroom) $('#title').html(element.name)


                        $('#mm-side-list').append(
                            `<li class="btn nav-item mm-side-image"><img src="https://www.moosen.im/images/favicon.png" alt="" class="circle img-fluid"><a class="nav-link mm-side-item-text" data-toggle="drawer" data-target="#dw-s1" room="${element.serialid}">${element.name}</a></li>`
                        )
                    })
                    $('.mm-side-item-text').each(function (index) {
                        $(this).css('font-size', '1em')
                        while ($(this).textWidth() > $('#dw-s1').width() * 0.65) {
                            $(this).css('font-size', (parseInt($(this).css('font-size')) - 1) +
                                "px")
                        }
                    })
                } catch (e) {}
            })

            $('#mm-side-list').on('click', 'a', function () {
                console.log("Room Button Clicked")
                $(this).parent().children().remove('.notify')
                socket.emit('changerooms', $(this.attributes.room).val())
            })

            socket.on('switchToRoom', async function (admin, room) {
                // console.log(admin)
                // console.log(room)
                if (!admin) {
                    $("#room-commands").css("display", "none")
                    $("#room-custom").css("display", "none")
                } else {
                    $("#room-commands").css("display", "block")
                    $("#room-custom").css("display", "block")
                }

                $('#messages').empty()
                $('#send-message').val('')
                $('#jc-room').html(room.join_code)
                $('#title').html(room.name)



                curroom = room.serialid
                first_id = null
                $('main').scrollTop(document.body.scrollHeight)

                if (room.back_img) css.backImg = room.back_img
                if (room.back2) {
                    css.back2 = room.back2
                    $('#back-color2').val(room.back2)
                }
                if (room.back1) {
                    css.back1 = room.back1
                    $('#back-color1').val(room.back1)
                    if (!room.back2) {
                        $('#back-color2').val(room.back1)
                    }
                }
                if (room.text_color) {
                    css.text1 = room.text_color
                    $('#text-color').val(room.text_color)
                }
                if (room.text_color2) css.text2 = room.text_color2
                if (room.message_back) {
                    css.mb1 =
                        `rgba(${parseInt(room.message_back.substr(1, 2), 16)}, 
                        ${parseInt(room.message_back.substr(3, 2), 16)}, 
                        ${parseInt(room.message_back.substr(5, 2), 16)}, 0.25)`
                    $('#msg-color1').val(room.message_back)
                } else {
                    css.mb1 = "rgba(0, 0, 0, 0)"
                    $('#msg-trans').prop('checked', true)
                }
                if (room.message_back2) {
                    $('#msg-color2').val()
                    css.mb2 =
                        `rgba(${parseInt(room.message_back2.substr(1, 2), 16)}, 
                        ${parseInt(room.message_back2.substr(3, 2), 16)}, 
                        ${parseInt(room.message_back2.substr(5, 2), 16)}, 0.25)`
                } else {
                    css.mb1 = "rgba(0, 0, 0, 0)"
                    $('#msg-trans').prop('checked', true)
                }
                handleCSS()
                canScroll = 0
                await sleep(500)
                canScroll = 10
            })

            socket.on('retreat', function () {
                console.log("Retreat!")
                window.location.href = "https://www.moosen.im/login"
            })

            socket.on('logout message', user => {
                $('#messages').append(
                    `<li id="${id}" class="mm-collection-item avatar">
                        <img src="${pic}" alt="" class="circle">
                        <span class="title" id="msgtitle">${user}</span>
                        <p class="message">${user} logged out</p>
                        <a class="secondary-content">${time}</a></li>`
                )
                checkScroll()
            })

            sleep = ms => new Promise(resolve => setTimeout(resolve, ms))

            async function insertMessage(msg, id, user, textMsg) {
                var wasInserted = false
                $('#messages li').each(function () {
                    // console.log($(this.children[1]).text())
                    if (id < this.id && !wasInserted) {
                        $(msg).insertBefore(this)
                        try {
                            // console.log($(this.previousElementSibling.children[1]).text())
                        } catch (e) {
                            console.log('Couldn\'t print')
                        }
                        wasInserted = true
                        checkScroll()
                    }
                })

                if (!wasInserted) {
                    $('#messages').append(msg)
                    document.title = user.replace(/ .*/, '') + ': ' + textMsg
                    checkScroll()
                }
                handleMessageCSS()

                await sleep(500)
                canScroll += 1
            }

            async function pageJump() {
                await sleep(500)
                retrieving = false
            }

            function checkScroll() {
                // console.log('canAuto: ' + canAuto)
                if (canAuto) {
                    $('main').scrollTop($('main').prop("scrollHeight"))
                }
            }

            function handleCSS() {
                if (css.backImg) {
                    $(".main").css("background-image", css.backImg)
                    $(".navbar").css("background", css.back1)
                } else if (css.back2) {
                    $(".main").css("background", `linear-gradient(to right, ${css.back1}, ${css.back2})`)
                    $(".navbar").css("background", `linear-gradient(to right, ${css.back1}, ${css.back2})`)
                } else {
                    $(".main").css("background", css.back1)
                    $(".navbar").css("background", css.back1)
                }
                $("#send-message").css("color", css.text1)
                $(".navbar a").css("color", css.text1)
                $(".navbar a i").css("color", css.text1)
                $(".navbar a button").css("color", css.text1)
                $(".mm-navdd button i").css("color", css.text1)
                handleMessageCSS()
            }

            function handleMessageCSS() {
                $(".mm-collection .mm-collection-item>.message").css("color", css.text1)
                $(".mm-collection .mm-collection-item>.title").css("color", css.text2)
                $(".mm-collection .mm-collection-item>.secondary-content").css("color", css.text2)
                $(".mm-collection li:nth-child(even)").css("background-color", css.mb1)
                $(".mm-collection li:nth-child(odd)").css("background-color", css.mb2)
                // $(".mm-collection .mm-collection-item>.message").css("background", "none")
                // $(".mm-collection .mm-collection-item>.message").children().css("background", "none")
            }

            function handleFileSelect(evt) {
                console.log('In handleFileSelect')
                var files = evt.target.files // FileList object
                for (var i = 0; i < files.length; i++) {
                    var name = files[i].name
                    var type = files[i].type
                    console.log("Filename: " + name + " , Type: " + type)
                    siofu.submitFiles([files[i]])
                }
            }
            document.getElementById('add_pics').addEventListener('change', handleFileSelect, false)

            if (window.File && window.FileReader && window.FileList && window.Blob) {
                // Great success! All the File APIs are supported.
            } else {
                alert('The File APIs are not fully supported in this browser.')
            }

            // notification code
            document.addEventListener('DOMContentLoaded', function () {
                if (!Notification) {
                    alert('dis broke as shit')
                    return
                }
                if (Notification.permission !== "granted")
                    Notification.requestPermission()
            })

            function notifyMe(msg, pic) {
                if (Notification.permission !== "granted")
                    Notification.requestPermission()
                else {
                    var notification = new Notification('Moosen IM', {
                        icon: pic,
                        body: msg,
                    })
                    notification.onclick = function () {
                        window.focus()
                    }
                }
            }
        })
    </script>

</body>

</html>